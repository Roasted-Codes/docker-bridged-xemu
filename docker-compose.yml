---
# ============================================================================
# Roasted-Codes xemu + XLink Kai Docker Compose Configuration
# ============================================================================
# This configuration provides:
#   - xemu emulator with custom config management and automation
#   - XLink Kai for LAN gaming over the internet
#
# Features:
#   - CPU-only rendering (no GPU required)
#   - Automatic config symlinking to /config/emulator/xemu.toml
#   - Optional passleader automation script (auto-runs if present)
#   - XLink Kai for system link gaming over internet
#
# Based on: LinuxServer.io docker-xemu
# See CHANGELOG.md for all modifications
# ============================================================================

# Virtual LAN for xemu + XLink Kai communication
# Both containers share this bridge for layer 2 broadcast traffic
networks:
  xemu_lan:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-xemu_lan
    ipam:
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1

volumes:
  tailscale-state:  # Persists Tailscale auth across container restarts

services:
  xemu:
    build: ./services/xemu
    image: xemu-bridged:latest
    container_name: xemu-halo2-server
    privileged: true  # Required for packet capture (pcap) in bridged mode
    security_opt:
      - seccomp:unconfined
    cap_add:
      - NET_ADMIN    # Required for bridged networking (TAP device)
    devices:
      - /dev/net/tun:/dev/net/tun  # Required for bridged networking
      - /dev/uinput:/dev/uinput    # Required for Selkies virtual gamepad
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      # CPU-only rendering settings (no GPU required)
      - DISABLE_ZINK=true
      - DISABLE_DRI3=true
      # Enable Selkies gamepad passthrough
      - SELKIES_GAMEPAD_ENABLED=true
    volumes:
      - ./services/xemu/data:/config
      - ./services/xemu/init:/custom-cont-init.d  # Run setcap as root at init
    ports:
      - 3000:3000   # HTTP interface
      - 3001:3001   # HTTPS interface (default, self-signed cert)
      - 4444:4444   # QMP (QEMU Machine Protocol)
    networks:
      xemu_lan:
        ipv4_address: 172.20.0.49
    dns:
      - 127.0.0.11  # Docker's embedded resolver (will forward to dnsmasq)
      - 172.20.0.2  # Fallback to local dnsmasq
    shm_size: "1gb"
    depends_on:
      - dhcp  # Ensure DHCP/DNS is running before xemu
    restart: unless-stopped

  xlinkkai:
    image: ich777/xlinkkaievolution
    container_name: xlinkkai
    environment:
      - INTERFACE_NAME=eth0  # Use container's bridge interface
      - UMASK=000
      - UID=99
      - GID=100
    volumes:
      - ./services/xlinkkai:/xlinkkaievolution
      - ./services/xlinkkai/user.sh:/opt/scripts/user.sh  # Auto-join arena on startup
    ports:
      - 34522:34522      # XLink Kai web interface
      - 30000:30000/udp  # P2P connections to orbital
      - 34523:34523/udp  # XLink Kai game tunneling
    networks:
      xemu_lan:
        ipv4_address: 172.20.0.25
    dns:
      - 127.0.0.11  # Docker's embedded resolver (will forward to dnsmasq)
      - 172.20.0.2  # Fallback to local dnsmasq
    privileged: true
    cap_add:
      - NET_ADMIN
    depends_on:
      - dhcp  # Ensure DHCP/DNS is running before xlinkkai
    restart: unless-stopped

  tailscale:
    image: tailscale/tailscale:latest
    container_name: xemu-tailscale2
    hostname: xemu-halocaster
    entrypoint: /bin/sh
    command: >
      -c "apk add --no-cache ethtool > /dev/null 2>&1;
          ethtool -K eth0 tx off 2>/dev/null || true;
          exec /usr/local/bin/containerboot"
    cap_add:
      - NET_ADMIN
      - NET_RAW
    sysctls:
      - net.ipv4.ip_forward=1
    environment:
      - TS_EXTRA_ARGS=--advertise-routes=172.20.0.0/24 --accept-dns=false
      - TS_STATE_DIR=/var/lib/tailscale
    volumes:
      - tailscale-state:/var/lib/tailscale
    ports:
      - 41641:41641/udp  # WireGuard port for direct connections
    networks:
      xemu_lan:
        ipv4_address: 172.20.0.10
    restart: unless-stopped

  # xbdm-relay:  # Disabled in favor of Tailscale direct access (uncomment if Tailscale not used)
  #   image: alpine/socat
  #   container_name: xbdm-relay
  #   entrypoint: /bin/sh
  #   command: >
  #     -c "apk add --no-cache ethtool > /dev/null 2>&1;
  #         ethtool -K eth0 tx off 2>/dev/null || true;
  #         exec socat TCP-LISTEN:731,reuseaddr,fork TCP:172.20.0.51:731"
  #   cap_add:
  #     - NET_ADMIN    # Required for ethtool to disable TX checksum offloading
  #   ports:
  #     - 127.0.0.1:731:731  # XBDM relay (localhost only, use SSH tunnel to access)
  #   networks:
  #     xemu_lan:
  #       ipv4_address: 172.20.0.11
  #   depends_on:
  #     - xemu
  #   restart: unless-stopped

  dhcp:
    image: drpsychick/dnsmasq
    container_name: xemu-dhcp
    cap_add:
      - NET_ADMIN    # Required for DHCP server
    networks:
      xemu_lan:
        ipv4_address: 172.20.0.2
    volumes:
      - ./services/dnsmasq/dnsmasq.conf:/etc/dnsmasq.conf:ro
    restart: unless-stopped

  # l2tunnel:
  #   build: ./services/l2tunnel
  #   container_name: l2tunnel
  #   cap_add:
  #     - NET_ADMIN
  #     - NET_RAW
  #   environment:
  #     - HUB_PORT=1337
  #     # XBOX_MAC auto-detected from EEPROM, or set manually:
  #     # - XBOX_MAC=00:50:f2:xx:xx:xx
  #   volumes:
  #     - ./services/xemu/data/emulator/iguana-eeprom.bin:/config/emulator/iguana-eeprom.bin:ro
  #   networks:
  #     xemu_lan:
  #       ipv4_address: 172.20.0.30
  #   restart: unless-stopped

