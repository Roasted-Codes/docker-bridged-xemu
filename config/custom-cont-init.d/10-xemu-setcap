#!/usr/bin/env bash
# =============================================================================
# Grant xemu network capabilities for pcap/bridged networking
# =============================================================================
# This script runs as root during container init (before xemu starts).
# It grants xemu the ability to open raw sockets on network interfaces,
# which is required for the pcap backend in bridged networking mode.
#
# Why here and not in autostart?
#   autostart runs as user 'abc' (uid 1000), which lacks CAP_SETFCAP.
#   custom-cont-init.d scripts run as root during s6-overlay init.
#
# Why register libraries with ld.so.conf?
#   setcap causes Linux to strip LD_LIBRARY_PATH (same as setuid binaries).
#   The AppImage's bundled libraries must be registered system-wide via
#   ldconfig so the dynamic linker can find them without LD_LIBRARY_PATH.
# =============================================================================

set -euo pipefail

XEMU_BIN="/opt/xemu/usr/bin/xemu"
XEMU_LIB="/opt/xemu/usr/lib"

# Enable promiscuous mode on eth0 so pcap can receive unicast frames
# addressed to the Xbox's emulated MAC (not the container's MAC)
echo "[10-xemu-setcap] Enabling promiscuous mode on eth0..."
ip link set eth0 promisc on

# Disable TX checksum offloading on eth0. The host kernel uses checksum
# offloading (leaves partial checksums for NIC hardware to complete), but
# packets to pcap-injected Xbox IPs traverse a software bridge â€” no hardware
# ever fills in the checksum. The Xbox's TCP stack silently drops packets
# with bad checksums, breaking all inbound TCP connections (FTP, XBDM, etc.)
# while ICMP ping still works (kernel computes ICMP checksums in software).
echo "[10-xemu-setcap] Disabling TX checksum offloading on eth0..."
ethtool -K eth0 tx off 2>/dev/null || true

if [ -f "$XEMU_BIN" ]; then
    # Register AppImage libraries with the system linker
    # This is required because setcap strips LD_LIBRARY_PATH
    echo "[10-xemu-setcap] Registering xemu libraries with system linker..."
    echo "$XEMU_LIB" > /etc/ld.so.conf.d/xemu.conf
    ldconfig

    # Grant network capabilities for pcap/bridged networking
    echo "[10-xemu-setcap] Setting network capabilities on xemu binary..."
    setcap cap_net_raw,cap_net_admin+eip "$XEMU_BIN"
    echo "[10-xemu-setcap] Done: $(getcap "$XEMU_BIN")"

    # Preserve LD_PRELOAD libraries for the setcap binary.
    # setcap triggers secure execution mode (AT_SECURE), which strips the
    # LD_PRELOAD env var. Selkies relies on LD_PRELOAD to inject its joystick
    # interposer into applications for browser-based gamepad/input support.
    # /etc/ld.so.preload is always honored regardless of secure execution mode,
    # so we write the interposer paths there to restore input functionality.
    INTERPOSER="/usr/lib/selkies_joystick_interposer.so"
    FAKE_UDEV="/opt/lib/libudev.so.1.0.0-fake"
    PCAP_IMMEDIATE="/config/emulator/pcap_immediate.so"

    # Auto-compile pcap_immediate.so if it doesn't exist
    if [ ! -f "$PCAP_IMMEDIATE" ]; then
        echo "[10-xemu-setcap] pcap_immediate.so not found, compiling..."
        if gcc -shared -fPIC -o "$PCAP_IMMEDIATE" /config/emulator/pcap_immediate.c -ldl; then
            echo "[10-xemu-setcap] Successfully compiled pcap_immediate.so"
        else
            echo "[10-xemu-setcap] ERROR: Failed to compile pcap_immediate.so - networking may not work!"
            exit 1
        fi
    fi

    if [ -f "$INTERPOSER" ]; then
        printf "%s\n%s\n" "$INTERPOSER" "$FAKE_UDEV" > /etc/ld.so.preload
        # Fix pcap receive: libpcap 1.9+ with TPACKET_V3 requires immediate
        # mode or the selectable fd never becomes readable. xemu doesn't set
        # this, so we shim pcap_activate to inject pcap_set_immediate_mode.
        if [ -f "$PCAP_IMMEDIATE" ]; then
            echo "$PCAP_IMMEDIATE" >> /etc/ld.so.preload
        fi
        echo "[10-xemu-setcap] Wrote ld.so.preload for setcap compatibility"
    fi
else
    echo "[10-xemu-setcap] WARNING: xemu binary not found at $XEMU_BIN"
fi
